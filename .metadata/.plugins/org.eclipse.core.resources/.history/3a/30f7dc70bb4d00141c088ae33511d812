package br.usjt.aepn2012.cardroiduino.ui;

import br.usjt.aepn2012.cardroiduino.R;
import br.usjt.aepn2012.cardroiduino.db.CarDroiDuinoDbAdapter;
import br.usjt.aepn2012.cardroiduino.utils.SystemProperties;
import android.app.Activity;
//import android.app.AlertDialog;
import android.bluetooth.BluetoothAdapter;
//import android.content.DialogInterface;
import android.content.Intent;
import android.database.Cursor;
import android.os.Bundle;
//import android.text.InputType;
import android.view.View;
//import android.widget.EditText;
import android.widget.ImageButton;

/**
 * <p>
 * <b>Description:</b> <br>
 * <p>
 * Home screen of DeadlyWheel System - Start Menu to Choose the Purpose Device :
 * Car Remote Control Server or remote control
 * </p>
 * 
 */
public class CarDroidDuinoActivity extends Activity {

	/**
	 * Port for connection - So much for the Remote Control as to the Server Add
	 * to Car
	 */
	private String port = "5002";

	/**
	 * IP address - So much for Remote Control and for the Server on car
	 */
	private String ipAddress = "192.168.0.1";

	/**
	 * Helper to assist in connection to SQLLite
	 */
	private CarDroiDuinoDbAdapter carDroiDuinoDbAdapter;

	/**
	 * MAC Address of Bluetooth Modem Car
	 */
	private String modemBluetoothMACAddress;

	/** Called when the activity is first created. */
	@Override
	public void onCreate(Bundle savedInstanceState) {

		// *************************************************
		// Performs first omtodo inherited class (Upper class - Extends )
		super.onCreate(savedInstanceState);

		// *************************************************
		// Which by setting the Layout ( XML ) Activity associated with this - >
		// CarDroiDuino \ res \ layout
		setContentView(R.layout.principal_layout);

		// *************************************************
		// Starting the connection to the Database
		this.carDroiDuinoDbAdapter = new CarDroiDuinoDbAdapter(this);
		this.carDroiDuinoDbAdapter.open();

		// *************************************************
		// Checking if properties were created 
		this.verifyBasicProperties();

		/*
		 * Bot�o de Abertura da Tela que executar� no Carrinho
		 */
		ImageButton btnOpenCarServer = (ImageButton) findViewById(R.id.btnCarro);
		btnOpenCarServer.setOnClickListener(new View.OnClickListener() {
			public void onClick(View v) {
				openCarServerActivity();
			}
		});

		/*
		 * Bot�o para Abertura da Tela de Controle Remoto do Carrinho
		 */
		ImageButton btnOpenCarControl = (ImageButton) findViewById(R.id.btnControle);
		btnOpenCarControl.setOnClickListener(new View.OnClickListener() {
			public void onClick(View v) {
				// openCarControlActivy();
				startCarControlActivity();
			}
		});

		/*
		 * Bot�o para Abertura da Tela de Propriedades do Sistema
		 */
		ImageButton btnOpenProperties = (ImageButton) findViewById(R.id.btnPropriedades);
		btnOpenProperties.setOnClickListener(new View.OnClickListener() {
			public void onClick(View v) {
				openPropertiesActivity();
			}
		});
	}

	/**
	 * Abre a Activity do Servidor do Carrinho A Abertura est� no evento
	 * onAtivityResult, pois s� abre a Activity depois de obter o MAC address do
	 * Modem bluetooth do carrinho
	 */
	private void openCarServerActivity() {
		if (!BluetoothAdapter.getDefaultAdapter().isEnabled()) {
			Intent enableIntent = new Intent(
					BluetoothAdapter.ACTION_REQUEST_ENABLE);
			startActivityForResult(enableIntent,
					SystemProperties.REQUEST_CODE_ENABLE_BLUETOOTH);
		} else {
			// this.obtainClientIPAddressAndRequestPort();
			openDeviceBluetoothList();
		}
	}

	/**
	 * Abre a Activity do Controle Remoto
	 */
	/*
	 * private void openCarControlActivy(){
	 * this.obtainServerIPAddressAndRequestPort(); }
	 */

	/**
	 * Abre a Activity de Propriedades do Sistema
	 */
	private void openPropertiesActivity() {
		// *************************************************
		// Criando Objeto para enviar a intencao de iniciar a Tela de
		// Propriedades
		Intent i = new Intent(this, SystemPropertiesActivity.class);
		// *************************************************
		// Enviando ao Sistema Operacional a intencao de iniciar a Activity
		startActivity(i);
	}

	/**
	 * Abre a Lista de Dispositivos Bluetooth para obter o MAC address do Modem
	 * no Carrinho O MAC address ser� retornado no Evento onActivityResult
	 */
	private void openDeviceBluetoothList() {
		// *************************************************
		// Cria o Objeto Intent para mostrar a intencao de abrir a Activity
		Intent serverIntent = new Intent(this,
				DeviceBluetoothListActivity.class);
		// *************************************************
		// Manda a intencao de abrir a Tela para o Sistema Operacional
		startActivityForResult(serverIntent,
				SystemProperties.REQUEST_CODE_CONNECT_BLUETOOTH);
	}

	/**
	 * Evento disparado quando retornado o resultudo de uma Activity Se
	 * retornado o MAC address do Modem bluetooth, inicializa a Activity
	 * Servidora do Carrinho Se o Intent retornado for da habilita��o do
	 * Bluetooth, chama novamente fun��o para abertura do Server do Carrinho
	 */
	@Override
	protected void onActivityResult(int requestCode, int resultCode, Intent data) {
		// *************************************************
		// Executa, primeiro, o metodo da Classe superior
		super.onActivityResult(requestCode, resultCode, data);
		// *************************************************
		// Verifica qual foi a Activity e qual foi o Resultado retornado pelo
		// Intent
		switch (requestCode) {
		// *************************************************
		// Retorno da Activity que lista os bluetooth encontrados
		case SystemProperties.REQUEST_CODE_CONNECT_BLUETOOTH:
			if (resultCode == Activity.RESULT_OK) {
				// *************************************************
				// Se for um resultado OK entao retornou o MAC Address do
				// Dispositivo ao qual o Server vai se conectar
				this.modemBluetoothMACAddress = data.getExtras().getString(
						SystemProperties.KEY_DEVICE_ADDRESS);
				// *************************************************
				// Inicia a Activity do Servidor
				startCarServerActivity();
			}
			break;
		// *************************************************
		// Retorno da Intent Inidicando que o Bluetooth foi Ativado
		case SystemProperties.REQUEST_CODE_ENABLE_BLUETOOTH:
			if (resultCode == Activity.RESULT_OK) {
				// *************************************************
				// Se o Bluetooth foi ativado entao inicia a abertura da
				// Activity do Servidor
				this.openCarServerActivity();
			}
			break;
		default:
			break;
		}
	}

	/**
	 * Abre a Tela de Servidor do Carrinho
	 * 
	 * @param port
	 */
	private void startCarServerActivity() {
		// *************************************************
		// Inicializa campos de IP e Porta
		this.loadIPAddressAndPort(
				SystemProperties.PROPERTIE_ID_IPADDRESS_CLIENT,
				SystemProperties.PROPERTIE_ID_PORT_CLIENT);
		// *************************************************
		// Criando Objeto para enviar a intencao de iniciar o Servidor do
		// Carrinho
		Intent i = new Intent(this, CarServerActivity.class);
		// *************************************************
		// Passando o Numero da Porta para o servidor enviar os Frames via UDP
		// ao Client
		i.putExtra(SystemProperties.KEY_PORT_NUMBER, this.port);
		// *************************************************
		// Passando o MAC Address do dispositivo Bluetooth para a Activity
		i.putExtra(SystemProperties.KEY_DEVICE_ADDRESS,
				this.modemBluetoothMACAddress);
		// *************************************************
		// Passando o Endereco IP do Client para envio dos Frames via UDP
		i.putExtra(SystemProperties.KEY_IP_ADDRESS, this.ipAddress);

		// Enviando ao Sistema Operacional a intencao de iniciar a Activity
		startActivity(i);
	}

	/**
	 * Abre a Tela de Controle Remoto do Carrinho
	 */
	private void startCarControlActivity() {
		// *************************************************
		// Inicializa campos de IP e Porta
		this.loadIPAddressAndPort(
				SystemProperties.PROPERTIE_ID_IPADDRESS_SERVER,
				SystemProperties.PROPERTIE_ID_PORT_SERVER);
		// *************************************************
		// Criando Objeto para enviar a intencao de iniciar o Controle (Client)
		// do Carrinho
		Intent i = new Intent(this, CarControlActivity.class);
		// *************************************************
		// Passando o Endere�o IP para o Client enviar os dados de comando ao
		// Server
		i.putExtra(SystemProperties.KEY_IP_ADDRESS, this.ipAddress);
		// *************************************************
		// Passando a Porta para o Client enviar os dados de Comando ao Server
		i.putExtra(SystemProperties.KEY_PORT_NUMBER, this.port);
		// *************************************************
		// Enviando ao Sistema Operacional a intencao de iniciar a Activity
		startActivity(i);
	}

	/**
	 * Carrega o IP e a Porta a ser utilizado - Se for abrir activity server
	 * ent�o carrega IP e Portas do Client se for abrir activity do cliente
	 * ent�o carrega IP e Portas do Server
	 * 
	 * @param idIPaddress
	 * @param idPort
	 */
	private void loadIPAddressAndPort(int idIPaddress, int idPort) {
		Cursor cursor;
		// *************************************************
		// Carrega o IP a ser utilizado
		cursor = this.carDroiDuinoDbAdapter.fetchPropertie(idIPaddress);
		startManagingCursor(cursor);
		this.ipAddress = cursor
				.getString(
						cursor.getColumnIndexOrThrow(SystemProperties.DATABASE_FIELD_PROP))
				.trim();

		cursor = null;
		// *************************************************
		// Carrega a Porta a ser utilizada
		cursor = this.carDroiDuinoDbAdapter.fetchPropertie(idPort);
		startManagingCursor(cursor);
		this.port = cursor
				.getString(
						cursor.getColumnIndexOrThrow(SystemProperties.DATABASE_FIELD_PROP))
				.trim();
	}

	/**
	 * Verifica se as propriedades b�sicas foram criadas no Banco de Dado Se n�o
	 * fora - Ent�o as Cria com valores default
	 */
	private void verifyBasicProperties() {

		// ************************************************
		// Verificando uma das propriedades
		Cursor cursor = this.carDroiDuinoDbAdapter
				.fetchPropertie(SystemProperties.PROPERTIE_ID_IPADDRESS_SERVER);
		startManagingCursor(cursor);

		// ************************************************
		// Verifica apenas uma prop - Se n�o estiver criada logo nenhuma outra
		// est�
		if (cursor.getCount() == 0) {
			// ************************************************
			// Inserindo prop do IP do Servidor
			this.carDroiDuinoDbAdapter
					.createPropertie(
							SystemProperties.PROPERTIE_ID_IPADDRESS_SERVER,
							SystemProperties.PROPERTIE_DEFAUL_VAL_IPADDRESS_SERVER,
							" ");

			// ************************************************
			// Inserindo prop da Porta do Servidor
			this.carDroiDuinoDbAdapter.createPropertie(
					SystemProperties.PROPERTIE_ID_PORT_SERVER,
					SystemProperties.PROPERTIE_DEFAUL_VAL_PORT_SERVER, " ");

			// ************************************************
			// Inserindo prop do IP do Client
			this.carDroiDuinoDbAdapter
					.createPropertie(
							SystemProperties.PROPERTIE_ID_IPADDRESS_CLIENT,
							SystemProperties.PROPERTIE_DEFAUL_VAL_IPADDRESS_CLIENT,
							" ");

			// ************************************************
			// Inserindo prop da Porta do Client
			this.carDroiDuinoDbAdapter.createPropertie(
					SystemProperties.PROPERTIE_ID_PORT_CLIENT,
					SystemProperties.PROPERTIE_DEFAUL_VAL_PORT_CLIENT, " ");
		}
	}
}